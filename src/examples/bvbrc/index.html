<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>BVBRC Plugin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        hr {
            margin: 10px;
        }
        h1, h2, h3, h4, h5 {
            margin-top: 5px;
            margin-bottom: 3px;
        }
        button {
            padding: 2px;
        }
        #app {
            width: 75%;
            left: 425px;
            top: 0px;
            position: absolute;
            padding: 0px;
            height: 100%;
        }
        #controls {
            width: 25%;
            left: 0;
            top: 0px;
            height: 100%;
            padding: 5px;
        }
    </style>
    <link rel="stylesheet" type="text/css" href="molstar.css" />
    <script type="text/javascript" src="./index.js"></script>
</head>
<body>
<div id="controls"></div>
<div id="app"></div>
<script type="text/javascript">
    let format = 'mmcif';
    const pdbId = getParam('pdb', '[^&]+').trim();
    const path = getParam('path', '[^&]+').trim();
    const selection = getParam('selection', '[^&]+').trim();
    const isRcsb = getParam('isRcsb', '[^&]+').trim();

    BVBRCMolStarWrapper.init('app').then(() => {
        let url;
        if (pdbId) {
            url = !isRcsb ? 'https://www.ebi.ac.uk/pdbe/static/entry/' + pdbId.toLowerCase() + '_updated.cif' : 'https://files.rcsb.org/download/' + pdbId + '-sf.cif';
        } else if (path) {
            url = path;
            format = 'pdb';
        }

        if (url) BVBRCMolStarWrapper.load({url, format, selection, displaySpikeSequence: true});
    });

    addControl('Apply HeatMap', () => BVBRCMolStarWrapper.coloring.applyHeatMap('/build/examples/bvbrc/pdb1jsd.ent.r4s'));
    addNewLine();
    addControl('Clear HeatMap', () => BVBRCMolStarWrapper.coloring.clearOverPaint(true));
    addSeparator();

    addFeatureSelect('feature', BVBRCMolStarWrapper.featureData);
    addNewLine();
    addSelect('overPaintColor', BVBRCMolStarWrapper.defaultColors);
    addNewLine();
    addControl('Apply OverPaint', () =>
        BVBRCMolStarWrapper.coloring.applyOverPaint(
            [{ seq: document.getElementById("feature").value,
                color: document.getElementById("overPaintColor").value}],
            document.getElementById("ligandColor").value)

    );
    addSeparator();

    addSelect('ligandColor', BVBRCMolStarWrapper.defaultColors);
    addNewLine();
    addControl('Apply Ligand', () => BVBRCMolStarWrapper.coloring.applyLigand(
        document.getElementById("ligandColor").value)
    );
    addSeparator();

    addControl('Clear OverPaint', () => BVBRCMolStarWrapper.coloring.clearOverPaint(true));

    function getParam(name, regex) {
        var r = new RegExp(name + '=' + '(' + regex + ')[&]?', 'i');
        return decodeURIComponent(((window.location.search || '').match(r) || [])[1] || '');
    }

    function addControl(label, action) {
        const btn = document.createElement('button');
        btn.onclick = action;
        btn.innerText = label;
        btn.style.marginBottom = "5px";
        document.getElementById('controls').appendChild(btn);
    }

    function addNewLine() {
        const br = document.createElement('br');
        document.getElementById('controls').appendChild(br);
    }

    function addSeparator() {
        const hr = document.createElement('hr');
        document.getElementById('controls').appendChild(hr);
    }

    function addHeader(header) {
        const h = document.createElement('h3');
        h.innerText = header;
        document.getElementById('controls').appendChild(h);
    }

    function addSelect(id, options) {
        let selectElement = document.createElement("select");
        selectElement.id = id;
        selectElement.style.marginBottom = "5px";
        document.getElementById('controls').appendChild(selectElement);

        for (const option of options) {
            let optionElement = document.createElement('option');
            optionElement.innerHTML = option[0];
            optionElement.value = option[1];
            selectElement.appendChild(optionElement);
        }
    }

    function addFeatureSelect(id, map) {
        let selectElement = document.createElement("select");
        selectElement.id = id;
        selectElement.style.marginBottom = "5px";
        document.getElementById('controls').appendChild(selectElement);

        const options = map[pdbId]
        if (options) {
            for (const option of options) {
                let optionElement = document.createElement('option');
                optionElement.innerHTML = option.name;
                optionElement.value = option.coords;
                selectElement.appendChild(optionElement);
            }
        }
    }
</script>
</body>
</html>
