<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>BVBRC Plugin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        #app {
            position: absolute;
            left: 160px;
            top: 100px;
            width: 600px;
            height: 600px;
            border: 1px solid #ccc;
        }

        #controls {
            position: absolute;
            width: 130px;
            top: 10px;
            left: 10px;
        }

        #controls > button {
            display: block;
            width: 100%;
            text-align: left;
        }

        #controls > hr {
            margin: 5px 0;
        }

        #controls > input, #controls > select {
            width: 100%;
            display: block;
        }

        .msp-plugin-content.msp-layout-expanded {
            margin-left: 150px;
        }
    </style>
    <link rel="stylesheet" type="text/css" href="molstar.css" />
    <script type="text/javascript" src="./index.js"></script>
    <style>
        .msp-plugin .msp-layout-expanded {
            position: fixed !important;
        }
    </style>
</head>
<body>
<div id='controls'>
    <!--<h3>Source</h3>
    <input type='text' id='url' placeholder='url' />
    <input type='text' id='assemblyId' placeholder='assembly id' />
    <select id='format'>
        <option value='mmcif' selected>mmCIF</option>
        <option value='pdb'>PDB</option>
    </select>-->
</div>
<div id="app"></div>
<script>
    function getParam(name, regex) {
        let r = new RegExp(name + '=' + '(' + regex + ')[&]?', 'i');
        return decodeURIComponent(((window.location.search || '').match(r) || [])[1] || '');
    }
    function $(id) { return document.getElementById(id); }

    var pdbId = getParam('pdb', '[^&]+').trim();
    var path = getParam('path', '[^&]+').trim();
    var selection = getParam('selection', '[^&]+').trim();
    var isRcsb = getParam('isRcsb', '[^&]+').trim();
    var assemblyId= '1';
    var format = 'mmcif';

    /*$('assemblyId').value = assemblyId;
    $('assemblyId').onchange = function (e) { assemblyId = e.target.value; }
    $('format').value = format;
    $('format').onchange = function (e) { format = e.target.value; }*/

    BVBRCMolStarWrapper.init('app' /** or document.getElementById('app') */);
    BVBRCMolStarWrapper.setBackground(0xffffff);

    let url;
    if (pdbId) {
        url = !isRcsb ? 'https://www.ebi.ac.uk/pdbe/static/entry/' + pdbId.toLowerCase() + '_updated.cif' : 'https://files.rcsb.org/download/' + pdbId + '-sf.cif';
    } else if (path) {
        url = path;
        format = 'pdb';
    }

    if (url) {
        BVBRCMolStarWrapper.load({url, format, selection, displaySpikeSequence: true});
    }

    addControl('Apply HeatMap', () => BVBRCMolStarWrapper.coloring.applyHeatMap('/build/examples/bvbrc/pdb1jsd.ent.r4s'));
    addControl('Clear HeatMap', () => BVBRCMolStarWrapper.coloring.clearOverPaint(true));

    /*addControl('Load Asym Unit', () => BVBRCMolStarWrapper.load({ url: url, format: format }));
    addControl('Load Assembly', () => BVBRCMolStarWrapper.load({ url: url, format: format, assemblyId: assemblyId }));

    addSeparator();

    addHeader('Camera');
    addControl('Toggle Spin', () => BVBRCMolStarWrapper.toggleSpin());

    addSeparator();

    addHeader('Animation');

    // adjust this number to make the animation faster or slower
    // requires to "restart" the animation if changed
    BVBRCMolStarWrapper.animate.modelIndex.targetFps = 30;

    addControl('Play To End', () => BVBRCMolStarWrapper.animate.modelIndex.onceForward());
    addControl('Play To Start', () => BVBRCMolStarWrapper.animate.modelIndex.onceBackward());
    addControl('Play Palindrome', () => BVBRCMolStarWrapper.animate.modelIndex.palindrome());
    addControl('Play Loop', () => BVBRCMolStarWrapper.animate.modelIndex.loop());
    addControl('Stop', () => BVBRCMolStarWrapper.animate.modelIndex.stop());

    addHeader('Misc');

    addControl('Apply Stripes', () => BVBRCMolStarWrapper.coloring.applyStripes());
    addControl('Apply Custom Theme', () => BVBRCMolStarWrapper.coloring.applyCustomTheme());
    addControl('Default Coloring', () => BVBRCMolStarWrapper.coloring.applyDefault());

    addHeader('Interactivity');
    addControl('Highlight seq_id=7', () => BVBRCMolStarWrapper.interactivity.highlightOn('DLE'));
    addControl('Clear Highlight', () => BVBRCMolStarWrapper.interactivity.clearHighlight());

    addHeader('Tests');

    addControl('Static Superposition', () => BVBRCMolStarWrapper.tests.staticSuperposition());
    addControl('Dynamic Superposition', () => BVBRCMolStarWrapper.tests.dynamicSuperposition());
    addControl('Validation Tooltip', () => BVBRCMolStarWrapper.tests.toggleValidationTooltip());

    addControl('Show Toasts', () => BVBRCMolStarWrapper.tests.showToasts());
    addControl('Hide Toasts', () => BVBRCMolStarWrapper.tests.hideToasts());*/

    addControl('Apply OverPaint', () => BVBRCMolStarWrapper.coloring.applyOverPaint(
        document.getElementById("feature").value,
        document.getElementById("overPaintColor").value)
    );

    addSelect('overPaintColor', BVBRCMolStarWrapper.defaultColors);

    addControl('Apply Ligand', () => BVBRCMolStarWrapper.coloring.applyLigand(
        document.getElementById("ligandColor").value)
    );

    addSelect('ligandColor', BVBRCMolStarWrapper.defaultColors);

    addControl('Clear OverPaint', () => BVBRCMolStarWrapper.coloring.clearOverPaint(true));

    ////////////////////////////////////////////////////////

    function addControl(label, action) {
        var btn = document.createElement('button');
        btn.onclick = action;
        btn.innerText = label;
        $('controls').appendChild(btn);
    }

    function addSeparator() {
        var hr = document.createElement('hr');
        $('controls').appendChild(hr);
    }

    function addHeader(header) {
        var h = document.createElement('h3');
        h.innerText = header;
        $('controls').appendChild(h);
    }

    function addSelect(id, options) {
        let selectElement = document.createElement("select");
        selectElement.id = id;
        $('controls').appendChild(selectElement);

        for (const option of options) {
            let optionElement = document.createElement('option');
            optionElement.innerHTML = option[0];
            optionElement.value = option[1];
            selectElement.appendChild(optionElement);
        }
    }
</script>
</body>
</html>
